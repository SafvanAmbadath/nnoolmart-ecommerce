<%- include("partials/user-header.ejs") -%>

        <!-- PAGE TITLE
        ================================================== -->
        <section class="page-title-section bg-img cover-background" data-background="img/bg/bg-8.jpg">
            <div class="container">

                <div class="title-info">
                    <h1>Shop Checkout</h1></div>
                <div class="breadcrumbs-info">
                    <ul class="ps-0">
                        <li><a href="home-shop-1.html">Home</a></li>
                        <li><a href="#">Shop Checkout</a></li>
                    </ul>
                </div>

            </div>
        </section>
        
        <!-- CHECKOUT
        ================================================== -->
        <section class="md">
            <div class="container">
                <form  method="post" id="checkout-form" class="colorlib-form" novalidate="novalidate">
                <div class="row">
                   
                    <!-- <div class="col-12">
                        <div class="process-steps mb-1-9 mb-lg-6">
                            <a class="step" href="shop-checkout-address.html"><i class="ti-direction-alt"></i><h4 class="step-title">1. Address</h4></a>
                            <a class="step" href="shop-checkout-shipping.html"><i class="ti-truck"></i><h4 class="step-title">2. Shipping</h4></a>
                            <a class="step active" href="shop-checkout-payment.html"><i class="ti-wallet"></i><h4 class="step-title">3. Payment</h4></a>
                            <a class="step" href="shop-checkout-review.html"><i class="ti-check-box"></i><h4 class="step-title">4. Review</h4></a>
                        </div>
                    </div> -->

                    <!-- left pannel section -->
                    <div class="col-lg-9 col-md-12 ps-2-3 mb-1-9 mb-lg-0">



<!-- product listing -->
<% for ( cart of cartItems.items) { %>
                        <div class="row g-0 product-listing" >

                            <div class="col-sm-4">
                                <div class="product-img">
                                    <a href="shop-product-detail.html">
                                        <img src="/img/<%= cart.product.imageUrl[0] %>" style="height: 85px;
                                        width: 60px;
                                        object-fit: cover; border-radius: 20%;" alt="..."></a>
                                </div>
                            </div>

                            <div class="col-sm-8">

                                <div class="product-list side-bar">

                                    <!-- <div class="product-description"> -->
                                        <div class="">
                                        <h5><a href="/product?productid=<%= cart.product._id %>"><%= cart.product.productName %> </a></h5>
                                        <!-- <h4 class="price"> -->
                                            <div>
                                                                                <span class="pe-2 display-29">Qty: <%= cart.quantity %></span>
                                                                                <span class="pe-2 display-29">₹<%= cart.totalPrice %></span>
                                                                            <!-- </h4> -->
                                            </div>
                                    <!-- </div> -->
                                                                    </div>
                                    

                                </div>

                            </div>

                        </div>

                        <% } %>
<!-- product listing end -->




                        <div class="common-block mb-2">

                            <div class="inner-title">
                                
                                <h5 class="mb-0"><span class="ti-location-pin pe-2 display-29"></span>Delivery Address</h5>
                            </div>
                            <% if(addAddressErr.length>0) {%>
                                <p class="form-text" id="" style="color:red"><%= addAddressErr %></p>
                                <% } %>
                                   


                            <div id="accordion" class="accordion-style3" >
							
								<% for( let i = 0; i < address.length; i++ ) { %>
								
								
							<div class="card">
							  <div class="card-header" id="headingOne">
								<% if (i==0) { %>
									<label><input type="radio" id="<%= address[i]._id %>" value="<%= address[i]._id %>" name="address" checked>Select address</label>
									<% } else { %>
										<label><input type="radio" id="<%= address[i]._id %>" value="<%= address[i]._id %>" name="address">Select address</label>
								<% } %>
								<h2 class="mb-0">
								  <button type="button" class="btn btn-link"  data-bs-toggle="collapse" data-bs-target="#collapseOne<%= address[i]._id %>" aria-expanded="true" aria-controls="collapseOne"><i class="ti-location-pin pe-2 display-29"></i>
									<%= address[i].addressType %>
								  </button>
								</h2>
								
							  </div>
						  
							  <div id="collapseOne<%= address[i]._id %>" class="collapse" name="addressLine" aria-labelledby="headingOne" data-bs-parent="#accordion">
								<div class="card-body">
                                    <address>
                                        <%= address[i].firstName %> <br>
                                        <%= address[i].addressLine %> <br>
                                        <%= address[i].city %>, 
                                        <%= address[i].state %>,
                                        <%= address[i].country %> <br>
                                        <%= address[i].pinCode %> ,
                                        
                                    </address>
									
								</div>
							  </div>
							</div>
							<% } %>
						  </div>


                            
                        <div class="mt-4">
                            <div class="mb-0">
                                <a href="/address" class="mb-0"><span class="fas fa-plus pe-2 display-29"></span>Add a new Address</a>
                                <!-- <a class="" href="/address" style="" data-bs-toggle="" data-bs-target="#" aria-expanded="false" aria-controls=""><span class="fas fa-plus"></span>Add a new address</a> -->
                            </div>
                        </div>
                            <!-- <div id="" class="accordion-style3">
                                <div class="card">
                                 <div class="card-header" id="headingOne">
                                
                            </div>

                        </div>    
                    </div>  -->
                </div> 






                        <div class="common-block">

                            <div class="inner-title">
                                <h5 class="mb-0">Choose Payment Method</h5>
                            </div>

                            

                            <!-- <div class="col-md-12">
                                <div class="radio">
                                   <label class=""><input class="mr-2 pe-2 display-29" type="radio" id="Cash-On-Delivery" value="cash on delivery"  name="paymentMethod">Cash on Delivery</label>
                                </div>
                            </div> -->


                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="Cash-On-Delivery" value="cash on delivery" >
                                <label class="form-check-label" for="Cash-On-Delivery">
                                Cash On Delivery
                              </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="Razorpay"  value="paypal" name="paymentMethod" checked>
                                <label class="form-check-label" for="Razorpay">
                                paypal
                              </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="wallet"  value="Wallet" name="paymentMethod">
                                <label class="form-check-label" for="wallet">
                                Wallet
                              </label>
                            </div>

                            <input type="text" name="cartId"  value="<%= cartItems._id %>" hidden>
                                                


                            <div id="accordion" class="accordion-style3">


                                
                                <!-- <div class="card">
                                    <div class="card-header" id="headingOne">
                                        <h5 class="mb-0">
                                        <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"><i class="far fa-credit-card pe-2 display-29"></i>Pay with Credit Card</button>
                                    </h5>
                                    </div>
                                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#accordion" style="">
                                        <div class="card-body">
                                            <h6 class="display-30 font-weight-600 mb-2">We accept following credit cards:</h6>

                                            <ul class="list-style-17 mb-4">
                                                <li><img src="img/content/payment-options/visa.png" alt="..."></li>
                                                <li><img src="img/content/payment-options/mastercard.png" alt="..."></li>
                                                <li><img src="img/content/payment-options/amex.png" alt="..."></li>
                                                <li><img src="img/content/payment-options/discover.png" alt="..."></li>
                                            </ul>

                                            <form>

                                                <div class="row">

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>First Name</label>
                                                            <input type="text" class="form-control" name="name" placeholder="Your name here">
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>Card Number</label>
                                                            <input type="text" class="form-control" name="cardnumber" placeholder="Your card number here">
                                                        </div>

                                                    </div>

                                                </div>

                                                <div class="row">

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>Month / Year</label>
                                                            <input type="text" class="form-control" name="month" placeholder="MM/YY">
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>CVC</label>
                                                            <input type="text" class="form-control" name="cvc" placeholder="CVC">
                                                        </div>

                                                    </div>

                                                </div>

                                                <a href="#" class="butn-style2 mt-3">Submit</a>

                                            </form>

                                        </div>
                                    </div>
                                </div> -->








                                <div class="card">
                                    <div class="card-header" id="headingTwo">
                                        <h5 class="mb-0">
                                        <button type="button" class="btn btn-link collapsed" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo"><i class="fab fa-paypal pe-2 display-29"></i>Pay with PayPal </button>
                                    </h5>
                                    </div>
                                    <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo" data-bs-parent="#accordion">
                                        <div class="card-body">

                                            <h6 class="display-30 font-weight-600 mb-2">Paypal takes good care of you.</h6>

                                            <div id="paypal-button-container"></div>

                                            <!-- <form> -->

                                                <!-- <div class="row">

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>Email Address</label>
                                                            <input type="text" class="form-control" name="email" placeholder="Your email address here">
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-6">

                                                        <div class="form-group">
                                                            <label>Password </label>
                                                            <input type="password" class="form-control" name="password" placeholder="Your password here">
                                                        </div>

                                                    </div>

                                                </div>

                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <a href="#" class="m-link-muted">Forgot password?</a>
                                                    </div>

                                                </div>

                                                <button type="button" class="butn-style2 mt-3">Login</button> -->

                                            <!-- </form> -->

                                        </div>
                                    </div>
                                </div>


                                <div class="card">
                                    <div class="card-header" id="headingThree">
                                        <h5 class="mb-0">
                                        <button type="button" class="btn btn-link collapsed" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree"><i class="fas fa-award pe-2 display-29"></i>nnoolmart wallet</button>
                                    </h5>
                                    </div>
                                    <div id="collapseThree" class="collapse show" aria-labelledby="headingThree" data-bs-parent="#accordion">
                                        <div class="card-body">

                                            <h6 class="display-30 font-weight-600 mb-2">You currently have <span class="text-medium"><%= userData.wallet %></span> Wallet amount to spend.</h6>

                                            <!-- <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="" id="reward_points">
                                                <label class="form-check-label" for="reward_points">Use my reward points to pay for this order.</label>
                                            </div> -->

                                        </div>
                                    </div>
                                </div>
                            </div>
                            








                            <!-- <div class="buttons-set">
                                <a href="shop-checkout-shipping.html" class="butn-style2 wide"><i class="fas fa-arrow-left me-1"></i> Back</a>
                                <a href="shop-checkout-review.html" class="butn-style2 wide">Place Order <i class="fas fa-arrow-right ms-1"></i></a>
                            </div> -->
                           

                        </div>

                    </div>
                    <!-- end left pannel section -->

                    <!-- right pannel section -->
                    <div class="col-lg-3 col-12 side-bar">

                        <div class="widget">

                            <div class="widget-title">
                                <h5>Order Summary</h5>
                            </div>

                            <table class="table classic">
                                <tbody>
                                    <tr>
                                        <th>Cart total:</th>
                                        <td class="text-gray-dark">
                                            <span><input type="text" name="subtotal" id="totalAmount"  class="form-control" value="<%= cartItems.cartTotalPrice%>" hidden >₹<%= cartItems.cartTotalPrice%></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Shipping:</th>
                                        <td class="text-gray-dark">
                                            Free 
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Discount:</th>
                                        <td class="text-gray-dark" id="discountAmount">
                                            No Discount 
                                        </td>
                                    </tr>
                                    <!-- <tr>
                                        <th>Estimated tax:</th>
                                        <td class="text-gray-dark">$9.72</td>
                                    </tr> -->
                                    <tr>
                                        <th>Total:</th>
                                        <td class="text-lg text-gray-dark">
                                            <span id="grandTotalAmount">₹<%= cartItems.cartTotalPrice%></span>
                                                <input type="text" name="total" id="grandTotal" value="<%= cartItems.cartTotalPrice%>" hidden >
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>


                        <!-- <div class="col-md-12">
                            <div class="row form-group">
                              <div class="col-sm-9">
                                <input type="text" name="couponCod" id="couponInput"  class="form-control input-number" placeholder="Your Coupon Number...">
                              </div>
                                  <p class="pl-5" id="CouponError"></p>
                              <div class="col-sm-3 mt-1 bd-example">
                                <input class="butn-style2 dark" type="button" onclick="applyCoupon('<%= cartItems.cartTotal%>')" style="display: block;" id="applyBtn" value="Apply Coupon" class="btn btn-primary">
                              </div>
                            </div>
                        </div> -->







                        <!-- <div class="col-lg-5 col-md-5 mb-1-9 mb-md-0"> -->
                            <div id="accordion" class="accordion-style3">
                                <div class="card">
                                    <div class="card-header" id="headingOne">
                                        <h5 class="mb-0">
                            <button type="button" class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                              Coupon Code
                            </button>
                                </h5>
                                    </div>
                                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#accordion">
                                        <div class="card-body">

                                          

                                                <div class="row">

                                                    <div class="col-sm-12 mb-2">

                                                        <div class="form-group">
                                                            <label>Enter Your Coupon Code</label>
                                                            <input type="text" class="form-control input-number" type="text" name="couponCod" id="couponInput" placeholder="Enter Your Coupon Code">
                                                        </div>
                                                        <p class="pl-5" id="CouponError"></p>

                                                    </div>

                                                </div>

                                                <input type="button" onclick="applyCoupon('<%= cartItems.cartTotalPrice%>')" id="applyBtn" value="Apply Coupon" class="butn-style2 dark">

                                            

                                        </div>
                                    </div>
                                </div>
                            </div>
                        <!-- </div> -->
                                











                        <div class="bd-example">
                              
                            <button type="submit" style="float: right;" id="placeorder" class="butn-style3">Place an Order<span></span></button>
                        </div>
<!-- 
                        <div class="widget">

                            <div class="widget-title">
                                <h5>Popular Products</h5>
                            </div>

                            <div class="d-flex mb-4">
                                <div class="flex-shrink-0">
                                    <img src="img/products/thumbs/thumb-06.jpg" alt="...">
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <a href="#" class="mb-1 font-weight-600 text-extra-dark-gray">Men's Football Boots</a>
                                    <span class="d-block">$15.00</span>
                                </div>
                            </div>

                            <div class="d-flex mb-4">
                                <div class="flex-shrink-0">
                                    <img src="img/products/thumbs/thumb-01.jpg" alt="...">
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <a href="#" class="mb-1 font-weight-600 text-extra-dark-gray">Leather Motorcycle Gloves</a>
                                    <span class="d-block">$12.10</span>
                                </div>
                            </div>

                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <img src="img/products/thumbs/thumb-02.jpg" alt="...">
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <a href="#" class="mb-1 font-weight-600 text-extra-dark-gray"> Sun Protection Cap </a>
                                    <span class="d-block">$10.20</span>
                                </div>
                            </div>

                        </div> -->

                    </div>
                    <!-- end right pannel section -->
                
                </div>
            </form>
            </div>
        </section>
        <%- include("partials/user-footer.ejs") -%>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous"  referrerpolicy="no-referrer"></script>
<script src="https://www.paypal.com/sdk/js?client-id=<%= clientId  %>" data-namespace="paypal_sdk"></script>




      <script>
        let CouponCode;
      function applyCoupon(subtotal) {
          
        CouponCode = document.getElementById("couponInput").value;
        console.log(CouponCode,'apply coupon');
        let total = subtotal;
        if (CouponCode == "") {
          document.getElementById("CouponError").style.color = "red";
          document.getElementById("CouponError").innerHTML = "Enter a Coupon Code";
        } else {
          $.ajax({
            url: "/verifycoupon",
            method: "post",
            data: {
              CouponCode,
              total,
            },
            success: (response) => {
              if (response.status == true) {
              // console.log(response.grandtotal);
                document.getElementById("CouponError").style.color = "green";
                document.getElementById("CouponError").innerHTML = "Coupon Applied";
                document.getElementById("discountAmount").innerHTML =
                  "Rs." + response.CutOff;
                document.getElementById("grandTotalAmount").innerHTML =
                  response.grandtotal;
                  document.getElementById("grandTotal").value =
                  response.grandtotal;
                document.getElementById("applyBtn").style.display = "none";
              } else {
                document.getElementById("CouponError").style.color = "red";
                document.getElementById("CouponError").innerHTML =
                  response.couponMsg;
              }
            },
          });
        }
      }


let userOrderData;
$("#checkout-form").submit((e) => {
  e.preventDefault();
//   console.log("submittedd");
  let couponAmount=document.getElementById("discountAmount").innerText 
          console.log(couponAmount);
  $.ajax({
    url: "/checkout/<%= cartItems._id %>",
    method: "post",
    data: $("#checkout-form").serialize(),couponAmount,
    success: (response) => {
      if(response.choosePay){
          const Toast = Swal.mixin({
             toast: true,
             position: 'top-end',
             showConfirmButton: false,
             timer: 3000,
             timerProgressBar: true,
             didOpen: (toast) => {
               toast.addEventListener('mouseenter', Swal.stopTimer)
               toast.addEventListener('mouseleave', Swal.resumeTimer)
             }
            } )
          
            Toast.fire({
            icon: 'error',
            title: 'please choose  your payment'
            })

         
      }else if (response.chooseAddress){

          const Toast = Swal.mixin({
          toast: true,
          position: '',
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
          }
           })

           Toast.fire({
            icon: 'error',
            title: 'must add your delivery address'
           })


      }else if(response.noBalance){
          const Toast = Swal.mixin({
           toast: true,
           position: 'top-end',
           showConfirmButton: false,
           timer: 3000,
           timerProgressBar: true,
           didOpen: (toast) => {
             toast.addEventListener('mouseenter', Swal.stopTimer)
             toast.addEventListener('mouseleave', Swal.resumeTimer)
           }
            })
            
            Toast.fire({
              icon: 'error',
              title: 'There is no balance in wallet',
            })

      }

      if (response.cashOnDelivery||response.wallet) {

              Swal.fire({
          title: "Order Placed Successfully",
          icon: "success",
          showDenyButton: false,
          confirmButtonText: " Order Successfully",
          // denyButtonText: `Continue Shopping`,
          toast: true,
        }).then((result) => {
          /* Read more about isConfirmed, isDenied below */
          if (result.isConfirmed) {
            location.href = "/order-complete";
          }
          
        });
      
      
      }else if(response.paypal){
        // console.log("response paypal")
        userOrderData=response.userOrderData
        walletBalance=response.walletAmount
        amount=response.amount
        paypal_sdk.Buttons({
            createOrder: function () {
                                return fetch("/create-order", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        items: [
                                            {
                                                id: 1,
                                                amount: amount,
                                            },
                                            { id: 2, amount: amount },
                                        ],
                                    }),
                                }).then(res => {
                                    // console.log("came");
                                    if (res.ok) return res.json()
                                    console.log(res.json());
                                    return res.json().then(json => Promise.reject(json))
                                }).then(({ id }) => {
                                    // console.log("pp");
                                    return id
                                }).catch(e => {
                                    // console.log("//// ");
                                    console.error(e)
                                })
                            },
                            onApprove: function (data, actions) {
                                console.log(data);
                                console.log(actions);
                                return actions.order.capture().then(function (details) {
                                    console.log('huuhu');
                                    console.log(response)
                                    verifyPayment(response) 
                                    alert("transaction completed")
                                })
                            }
                      
                        }).render('#paypal-button-container')
                        document.getElementById("placeorder").style.display="none"
      } 
     
    },
  });
});
//   let Couponcode = document.getElementById("couponInput").value;

function verifyPayment(verifyData) {
            console.log("paypal")
            console.log(walletBalance);
            console.log(verifyData)
            console.log(userOrderData)
            
            $.ajax({
                url: "/verifypayment",
                data: {
                    // verifyData:verifyData,
                    userOrderData:verifyData.userOrderData,
                    CouponCode:CouponCode,
                    amount:amount,
                    walletBalance:walletBalance

                },
                method: "post",
                success: (response) => {
                    console.log(response);
                    if (response.status) {
                        Swal.fire({
                            title: 'Order Placed Successfully',
                            icon: "success",
                            showDenyButton: false,
                            confirmButtonText: " Order Successfully",
                            toast: true,
                        }).then((result) => {
                            console.log(result);
                            if (result.isConfirmed) {
                                location.href = "/Order-complete"
                            }
                        })
                    }
                }
            })

        }


      </script>
        
       